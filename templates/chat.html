<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assistant Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .ocb-blue { background-color: #2563eb; }
        .text-ocb-blue { color: #2563eb; }
        .prose { max-width: 100%; }
        .prose p { margin: 0.5em 0; }
        .prose ul, .prose ol { margin: 0.5em 0; padding-left: 1.5em; }
        .prose-invert { color: white; }
        .rtl { direction: rtl; text-align: right; }
        .rtl .prose ul, .rtl .prose ol { padding-right: 1.5em; padding-left: 0; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="flex h-screen bg-gray-50">
        <!-- Chat History Sidebar -->
        <div id="sidebar" class="w-80 bg-white shadow-lg border-r border-gray-200 flex-col hidden lg:flex">
            <div class="p-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-history text-ocb-blue mr-2"></i>
                    <span data-en="Chat History" data-ar="سجل المحادثات">Chat History</span>
                </h2>
                <button id="newChatBtn" class="mt-2 w-full bg-blue-600 text-white px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700 transition-colors">
                    <i class="fas fa-plus mr-2"></i>
                    <span data-en="New Chat" data-ar="محادثة جديدة">New Chat</span>
                </button>
            </div>
            <div id="chatHistoryList" class="flex-1 overflow-y-auto p-4 space-y-2">
                <div class="text-center text-gray-500 py-8">
                    <i class="fas fa-comments text-2xl mb-2"></i>
                    <p class="text-sm" data-en="No chat history yet" data-ar="لا يوجد سجل محادثات بعد">No chat history yet</p>
                </div>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="flex-1 flex flex-col">
            <!-- Header -->
            <div class="bg-white border-b border-gray-200 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">
                            <i class="fas fa-comments text-blue-600 mr-3"></i>
                            <span data-en="AI Assistant Chat" data-ar="مساعد الذكاء الاصطناعي">AI Assistant Chat</span>
                        </h1>
                        <p class="mt-1 text-gray-600 text-sm" data-en="Chat with AI assistant powered by Google Gemini" data-ar="تحدث مع مساعد الذكاء الاصطناعي مدعوم بـ Google Gemini">
                            Chat with AI assistant powered by Google Gemini
                        </p>
                    </div>
                    <button id="mobileMenuBtn" class="lg:hidden inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        <i class="fas fa-history mr-2"></i>
                        <span data-en="History" data-ar="السجل">History</span>
                    </button>
                </div>
            </div>

            <!-- Chat Messages -->
            <div class="flex-1 overflow-y-auto p-6 bg-white">
                <div id="chatMessages" class="space-y-6 max-w-5xl mx-auto">
                    <div class="text-center text-gray-500 py-12">
                        <i class="fas fa-comments text-4xl mb-4 text-gray-400"></i>
                        <p class="text-lg" data-en="Start a conversation with the AI assistant" data-ar="ابدأ محادثة مع مساعد الذكاء الاصطناعي">Start a conversation with the AI assistant</p>
                        <p class="text-sm mt-2" data-en="Ask questions or upload documents" data-ar="اطرح الأسئلة أو قم بتحميل المستندات">Ask questions or upload documents</p>
                    </div>
                </div>
            </div>

            <!-- Recording Modal -->
            <div id="recordingModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center transition-opacity duration-300">
                <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-2xl mx-4">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-3">
                            <div class="relative">
                                <i class="fas fa-microphone text-red-600 text-2xl"></i>
                                <span class="absolute -top-1 -right-1 flex h-3 w-3">
                                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                                    <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                                </span>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-900" data-en="Listening..." data-ar="الاستماع...">Listening...</h3>
                                <p class="text-sm text-gray-600" data-en="Speak now" data-ar="تحدث الآن">Speak now</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-xl p-6 mb-6">
                        <div class="flex items-center justify-center space-x-2">
                            <div class="w-2 h-8 bg-red-600 rounded animate-pulse" style="animation-delay: 0s"></div>
                            <div class="w-2 h-12 bg-red-600 rounded animate-pulse" style="animation-delay: 0.1s"></div>
                            <div class="w-2 h-10 bg-red-600 rounded animate-pulse" style="animation-delay: 0.2s"></div>
                            <div class="w-2 h-14 bg-red-600 rounded animate-pulse" style="animation-delay: 0.3s"></div>
                            <div class="w-2 h-8 bg-red-600 rounded animate-pulse" style="animation-delay: 0.4s"></div>
                        </div>
                    </div>
                    
                    <button type="button" id="stopRecordingBtn" class="w-full inline-flex items-center justify-center px-6 py-4 border border-transparent text-base font-semibold rounded-xl text-white bg-red-600 hover:bg-red-700 transition-all duration-200 shadow-lg">
                        <i class="fas fa-stop mr-3 text-xl"></i>
                        <span data-en="Stop Listening" data-ar="إيقاف الاستماع">Stop Listening</span>
                    </button>
                </div>
            </div>

            <!-- Chat Input Area -->
            <div class="bg-white border-t border-gray-200 p-6">
                <div id="fileUploadArea" class="hidden mb-4">
                    <div class="border border-gray-300 border-dashed rounded-lg p-4 transition-all duration-300">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-file text-gray-400"></i>
                                <span class="text-sm text-gray-600" id="uploadedFileName">No file selected</span>
                            </div>
                            <button type="button" id="removeFileBtn" class="text-red-500 hover:text-red-700 text-sm transition-colors">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <form id="chatForm" class="max-w-4xl mx-auto space-y-4">
                    <div class="flex items-end space-x-3">
                        <button type="button" id="uploadBtn" class="flex-shrink-0 inline-flex items-center justify-center w-11 h-11 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 hover:border-gray-400 transition-all duration-200 shadow-sm">
                            <i class="fas fa-paperclip text-lg"></i>
                        </button>
                        <input type="file" id="fileInput" accept=".pdf,.txt,.doc,.docx" class="hidden">
                        
                        <button type="button" id="recordBtn" class="flex-shrink-0 inline-flex items-center justify-center w-11 h-11 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 hover:border-gray-400 transition-all duration-200 shadow-sm">
                            <i class="fas fa-microphone text-lg text-red-600"></i>
                        </button>
                        
                        <div class="flex-1 relative">
                            <textarea id="message" rows="3" class="shadow-sm focus:ring-2 focus:ring-blue-600 focus:border-blue-600 block w-full text-sm border-gray-300 rounded-lg resize-none transition-all duration-200 pr-3 py-3 px-4" placeholder="Ask a question..." required></textarea>
                        </div>
                        
                        <div class="flex flex-col space-y-2">
                            <select id="language" class="block w-24 pl-3 pr-8 py-2.5 text-sm border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-blue-600 rounded-lg transition-all duration-200 shadow-sm">
                                <option value="en">English</option>
                                <option value="ar">العربية</option>
                            </select>
                            <button type="submit" class="inline-flex items-center justify-center px-5 py-2.5 border border-transparent text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 transition-all duration-200 shadow-sm hover:shadow-md">
                                <i class="fas fa-paper-plane mr-2"></i>
                                <span data-en="Send" data-ar="إرسال">Send</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
    (function() {
        'use strict';
        
        // ========== CONFIGURATION ==========
        const API_KEY = 'AIzaSyBX5T_0LqeeVa6Bu5y7MOAHSKngF547920';
        const API_ENDPOINT = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent';
        
        // ========== STATE ==========
        let chatHistory = [];
        let selectedFile = null;
        let pdfContent = '';
        let currentLanguage = 'en';
        let recognition = null;
        
        // ========== ELEMENTS ==========
        const chatMessages = document.getElementById('chatMessages');
        const chatForm = document.getElementById('chatForm');
        const messageInput = document.getElementById('message');
        const languageSelect = document.getElementById('language');
        const uploadBtn = document.getElementById('uploadBtn');
        const fileInput = document.getElementById('fileInput');
        const fileUploadArea = document.getElementById('fileUploadArea');
        const uploadedFileName = document.getElementById('uploadedFileName');
        const removeFileBtn = document.getElementById('removeFileBtn');
        const newChatBtn = document.getElementById('newChatBtn');
        const recordBtn = document.getElementById('recordBtn');
        const recordingModal = document.getElementById('recordingModal');
        const stopRecordingBtn = document.getElementById('stopRecordingBtn');
        
        // ========== LANGUAGE SWITCHING ==========
        function updateUILanguage(lang) {
            currentLanguage = lang;
            
            document.querySelectorAll('[data-en][data-ar]').forEach(element => {
                element.textContent = lang === 'ar' ? element.getAttribute('data-ar') : element.getAttribute('data-en');
            });
            
            if (lang === 'ar') {
                messageInput.placeholder = 'اطرح سؤالاً...';
                messageInput.classList.add('rtl');
            } else {
                messageInput.placeholder = 'Ask a question...';
                messageInput.classList.remove('rtl');
            }
        }
        
        languageSelect.addEventListener('change', (e) => {
            updateUILanguage(e.target.value);
        });
        
        // ========== UTILITY FUNCTIONS ==========
        function addMessage(type, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${type === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = type === 'user' ? 'max-w-[70%]' : 'max-w-[70%]';
            
            if (type === 'assistant') {
                const labelDiv = document.createElement('div');
                labelDiv.className = 'flex items-center mb-2 ml-1';
                labelDiv.innerHTML = `
                    <i class="fas fa-robot text-blue-600 mr-2"></i>
                    <span class="text-xs font-medium text-gray-600">${currentLanguage === 'ar' ? 'مساعد الذكاء الاصطناعي' : 'AI Assistant'}</span>
                `;
                bubbleDiv.appendChild(labelDiv);
            }
            
            const contentDiv = document.createElement('div');
            const isRTL = /[\u0600-\u06FF]/.test(content);
            contentDiv.className = `px-6 py-4 rounded-3xl shadow-md ${type === 'user' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-900'} ${isRTL ? 'rtl' : ''}`;
            contentDiv.innerHTML = `<div class="text-sm prose prose-sm max-w-none ${type === 'user' ? 'prose-invert' : ''}">${marked.parse(content)}</div>`;
            
            bubbleDiv.appendChild(contentDiv);
            messageDiv.appendChild(bubbleDiv);
            
            const welcome = chatMessages.querySelector('.text-center');
            if (welcome) {
                chatMessages.innerHTML = '';
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            return messageDiv;
        }
        
        async function callAI(prompt) {
            const response = await fetch(`${API_ENDPOINT}?key=${API_KEY}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.7,
                        maxOutputTokens: 2048,
                    }
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'API request failed');
            }
            
            const data = await response.json();
            
            if (data.candidates && data.candidates.length > 0) {
                return data.candidates[0].content.parts[0].text;
            } else {
                throw new Error('No response from AI');
            }
        }
        
        // ========== FILE UPLOAD ==========
        uploadBtn.addEventListener('click', () => {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            selectedFile = file;
            uploadedFileName.textContent = file.name;
            fileUploadArea.classList.remove('hidden');
            
            const reader = new FileReader();
            reader.onload = async (event) => {
                const text = event.target.result;
                pdfContent = text.substring(0, 8000);
                
                const uploadMsg = currentLanguage === 'ar' ? `📄 تم التحميل: ${file.name}` : `📄 Uploaded: ${file.name}`;
                const readyMsg = currentLanguage === 'ar' 
                    ? '📋 تم تحميل المستند! يمكنني الآن الإجابة على الأسئلة حول هذا المستند. ماذا تريد أن تعرف؟'
                    : '📋 Document uploaded! I can now answer questions about this document. What would you like to know?';
                
                addMessage('user', uploadMsg);
                addMessage('assistant', readyMsg);
            };
            reader.readAsText(file);
        });
        
        removeFileBtn.addEventListener('click', () => {
            selectedFile = null;
            pdfContent = '';
            fileInput.value = '';
            fileUploadArea.classList.add('hidden');
        });
        
        // ========== CHAT FORM ==========
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const message = messageInput.value.trim();
            if (!message) return;
            
            addMessage('user', message);
            messageInput.value = '';
            
            const typingMsg = currentLanguage === 'ar' ? '💭 جارٍ التفكير...' : '💭 Thinking...';
            const typingDiv = addMessage('assistant', typingMsg);
            
            try {
                let prompt = '';
                
                if (pdfContent) {
                    prompt = `You are a helpful AI assistant. Answer the following question based on this document:\n\nDocument:\n${pdfContent}\n\nQuestion: ${message}\n\n`;
                } else {
                    prompt = message;
                }
                
                if (currentLanguage === 'ar') {
                    prompt += '\n\nIMPORTANT: Respond in Arabic language only.';
                }
                
                const response = await callAI(prompt);
                
                typingDiv.remove();
                addMessage('assistant', response);
                
            } catch (error) {
                typingDiv.remove();
                const errorMsg = currentLanguage === 'ar' 
                    ? `❌ خطأ: ${error.message}`
                    : `❌ Error: ${error.message}`;
                addMessage('assistant', errorMsg);
            }
        });
        
        // ========== NEW CHAT ==========
        newChatBtn.addEventListener('click', () => {
            chatHistory = [];
            pdfContent = '';
            selectedFile = null;
            
            const welcomeMsg = currentLanguage === 'ar' 
                ? `<div class="text-center text-gray-500 py-12">
                    <i class="fas fa-comments text-4xl mb-4 text-gray-400"></i>
                    <p class="text-lg">ابدأ محادثة مع مساعد الذكاء الاصطناعي</p>
                    <p class="text-sm mt-2">اطرح الأسئلة أو قم بتحميل المستندات</p>
                   </div>`
                : `<div class="text-center text-gray-500 py-12">
                    <i class="fas fa-comments text-4xl mb-4 text-gray-400"></i>
                    <p class="text-lg">Start a conversation with the AI assistant</p>
                    <p class="text-sm mt-2">Ask questions or upload documents</p>
                   </div>`;
            
            chatMessages.innerHTML = welcomeMsg;
            messageInput.value = '';
            if (selectedFile) removeFileBtn.click();
        });
        
        // ========== VOICE RECOGNITION ==========
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                messageInput.value = transcript;
                recordingModal.classList.add('hidden');
            };
            
            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                recordingModal.classList.add('hidden');
                const errorMsg = currentLanguage === 'ar' 
                    ? 'خطأ في التعرف على الصوت'
                    : 'Voice recognition error';
                alert(errorMsg);
            };
            
            recognition.onend = () => {
                recordingModal.classList.add('hidden');
            };
        }
        
        recordBtn.addEventListener('click', () => {
            if (!recognition) {
                const errorMsg = currentLanguage === 'ar' 
                    ? 'التعرف على الصوت غير مدعوم في هذا المتصفح'
                    : 'Voice recognition not supported in this browser';
                alert(errorMsg);
                return;
            }
            
            recognition.lang = currentLanguage === 'ar' ? 'ar-SA' : 'en-US';
            recognition.start();
            recordingModal.classList.remove('hidden');
            updateUILanguage(currentLanguage);
        });
        
        stopRecordingBtn.addEventListener('click', () => {
            if (recognition) {
                recognition.stop();
            }
            recordingModal.classList.add('hidden');
        });
        
        // ========== MOBILE MENU ==========
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const sidebar = document.getElementById('sidebar');
        
        if (mobileMenuBtn && sidebar) {
            mobileMenuBtn.addEventListener('click', () => {
                sidebar.classList.toggle('hidden');
                sidebar.classList.toggle('absolute');
                sidebar.classList.toggle('z-50');
            });
        }
        
        // ========== ENTER KEY ==========
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatForm.dispatchEvent(new Event('submit'));
            }
        });
        
        console.log('OMAN Chatbot initialized with Google Gemini 1.5 Flash');
        
    })();
    </script>
</body>
</html>